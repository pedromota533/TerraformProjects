# Ansible GitHub Runner Setup Environment

## Overview

This directory contains an Ansible-based automation solution for deploying and managing GitHub Actions self-hosted runners on remote machines. The playbook handles the complete lifecycle of runners: installation, configuration, execution, and removal.

## Requirements

### System Requirements
- **Python 3** - Required for Ansible and virtual environment
- **Bash** - Shell interpreter
- **SSH Access** - To target EC2 instances
- **Terraform** - Must be run first to provision infrastructure and generate inventory

### Auto-Installed Dependencies
The `run` script automatically installs the following in a Python virtual environment:
- **Ansible** - Configuration management tool
- **Python dependencies** - Managed via `requirements.txt`

**Note:** You do NOT need to manually install Ansible. The `run` script handles all setup automatically.

## Directory Structure

```
ansible_enviroment/
├── README.md                           # This documentation
├── run                                 # Automated setup and execution script
├── run-scripts.yml                     # Main Ansible playbook
├── .venv/                              # Python virtual environment (auto-generated)
├── requirements.txt                    # Python dependencies (auto-generated)
├── logs/                               # Execution logs (auto-generated)
└── scripts/                            # Shell scripts executed on remote hosts
    ├── 00-install-dependencies.sh      # System dependencies installation
    ├── 10-github_runner_setup.sh       # Runner download, config, and startup
    └── 20-remove-github-runner.sh      # Runner removal and cleanup
```

## Quick Start

1. **Run Terraform first** to provision infrastructure and generate `../config/config.ini`

2. **Configure GitHub Runner Token**
   - Edit `../config/config.ini`
   - Set the `github_runner_token` value (get from GitHub repo settings)

3. **Deploy Runners**
   ```bash
   cd ansible_enviroment
   ./run [CONFIG_PATH]
   ```

   **Examples:**
   - Default location: `./run` (uses `../config/config.ini`)
   - Custom location: `./run /path/to/my-config.ini`
   - Absolute path: `./run ~/configs/production.ini`

The `run` script will automatically:
- ✓ Validate configuration file and GitHub token
- ✓ Check Python 3 installation
- ✓ Create/reuse Python virtual environment
- ✓ Install Ansible
- ✓ Execute the playbook
- ✓ Report results with appropriate exit codes

**Exit Codes:** 0=Success, 1=Config missing, 2=Empty token, 3=No Python3, 4-6=Environment errors, 7+=Ansible errors

## Configuration

### Inventory File
The inventory file is **automatically generated by Terraform** and located at `../config/config.ini`.

**Example format:**
```ini
[runners]
# Individual IPs (one per line)
1.2.3.4
5.6.7.8

[runners:vars]
ansible_ssh_private_key_file=~/.ssh/aws_permision_file_work.pem
ansible_user=ubuntu
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
ansible_python_interpreter=/usr/bin/python3

# GitHub Runner Configuration
github_repo_url=https://github.com/owner/repo
github_runner_token=YOUR_TOKEN_HERE
github_runner_version=2.329.0
github_runner_dir=/home/ubuntu/actions-runner
github_runner_labels=self-hosted,linux,x64
remove_runner=false
```

## Components

### Scripts

#### `00-install-dependencies.sh`

Installs system-level dependencies required for the GitHub runner.

**What it does:**
- Updates system packages
- Installs essential tools: `curl`, `tar`, `git`, `coreutils`, `jq`, `wget`, `unzip`
- Validates that critical commands are available

**Execution:** Runs as root

#### `10-github_runner_setup.sh`

Main runner installation and configuration script with robust error handling.

**What it does:**
- Downloads GitHub Actions runner (version 2.329.0 by default)
- Validates download integrity using SHA256 hash
- Extracts runner archive
- Configures runner with provided credentials
- Attempts to install as systemd service
- Falls back to background process if service installation fails
- Includes smart skip logic: won't reinstall if runner is already healthy

**Environment Variables:**
- `REPO_URL`: GitHub repository URL (required)
- `RUNNER_TOKEN`: Registration token (required)
- `RUNNER_VERSION`: Runner version (default: 2.329.0)
- `RUNNER_DIR`: Installation directory (default: ~/actions-runner)
- `RUNNER_NAME`: Runner name (default: hostname-runner)
- `RUNNER_LABELS`: Custom labels (default: self-hosted,linux,x64)

**Execution:** Runs as ansible_user

#### `20-remove-github-runner.sh`

Conditional removal script for cleaning up GitHub runners.

**What it does:**
- Only executes if `REMOVE_RUNNER=true`
- Stops systemd service if running
- Kills background process if exists
- Removes runner configuration from GitHub
- Deletes runner directory completely

**Environment Variables:**
- `REMOVE_RUNNER`: Must be set to `true` to execute removal
- `RUNNER_TOKEN`: Required for configuration removal
- `RUNNER_DIR`: Directory to remove (default: ~/actions-runner)

**Execution:** Runs as ansible_user

## Logging

All script outputs are saved to the `logs/` directory. Failed scripts are marked with `_FAILED` suffix.

**View logs:**
```bash
cat logs/runner-01_10-github_runner_setup.sh.log
```

**Check runner logs on remote host:**
```bash
tail -f ~/actions-runner/_diag/Runner_*.log
```

## How It Works (PlayBook)

2. **Discovery Phase (Ansible)**
   - Ansible finds all `*.sh` files in `scripts/` directory
   - Creates remote temporary directory `/tmp/ansible_scripts`

3. **Dependency Installation (Scripts `0X-*`)**
   - Copies scripts to remote hosts
   - Executes as root user
   - Installs system packages and tools

4. **Runner Setup (Scripts `1X-*`)**
   - Creates runner directory with correct ownership
   - Executes as ansible_user
   - Passes environment variables for configuration
   - Downloads, validates, and installs runner
   - Starts runner as service or background process

5. **Logging and Cleanup**
   - Saves all stdout/stderr to local log files
   - Removes temporary scripts directory on remote hosts

## Advanced Usage

### Custom Config Location

Use a custom config file location:
```bash
./run /path/to/custom-config.ini
```

### Removing Runners
To remove all runners from hosts:

1. Edit your config file (default: `../config/config.ini`)
2. Set `remove_runner=true`
3. Run: `./run [CONFIG_PATH]`

Or manually with ansible-playbook:
```bash
source .venv/bin/activate
ansible-playbook run-scripts.yml -i /path/to/config.ini -e "remove_runner=true"
```

### Running Against Specific Hosts

```bash
source .venv/bin/activate
ansible-playbook run-scripts.yml -i /path/to/config.ini --limit 52.29.136.181
```

### Updating Runner Version

1. Edit `../config/config.ini` and set desired version (e.g., `github_runner_version=2.330.0`)
2. Update `EXPECTED_HASH` in `scripts/10-github_runner_setup.sh:16` for the new version
3. Run: `./run`

## Error Handling

- All scripts use `set -euo pipefail` for strict error handling
- Failed scripts are logged with `_FAILED` suffix
- Playbook continues execution even if individual scripts fail
- Runner setup includes automatic retry with full reinstall
- Hash validation prevents corrupted downloads
- The `run` script uses `set -e` to exit on first error

## Security Considerations

- Runner tokens should be treated as secrets
- Never commit `config.ini` with real tokens to git
- Use Ansible Vault for sensitive variables in production
- SHA256 hash validation ensures download integrity
- Scripts run with minimum required privileges
- Temporary files are cleaned up after execution
- SSH strict host key checking is disabled for automation (consider enabling in production)

## Maintenance

### Checking Runner Status

SSH to host and check:
```bash
cd ~/actions-runner
sudo ./svc.sh status
```

### Cleaning Up

Remove all runners (set `remove_runner=true` in config.ini, then run `./run`)

Remove local environment:
```bash
rm -rf .venv/ logs/ requirements.txt
```

## Customization

### Adding New Scripts

1. Create a new shell script in `scripts/` directory
2. Use numeric prefix to control execution order
   - `0X-` for root execution
   - `1X-9X-` for user execution
3. Make script executable: `chmod +x scripts/XX-name.sh`
4. Use environment variables passed by playbook

### Modifying the `run` Script

The `run` script accepts an optional config path argument:
```bash
./run [CONFIG_PATH]
```

If not provided, defaults to `../config/config.ini`. Common modifications:
- Add additional validation checks
- Install additional Python packages
- Add pre/post execution hooks

## Contributing

When adding new scripts:
1. Follow the naming convention
2. Include comprehensive error handling
3. Add logging statements
4. Document environment variables
5. Test in isolation before integration

## License

Part of the terraform-github-constructor project.
