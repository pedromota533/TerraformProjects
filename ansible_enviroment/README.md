# Ansible GitHub Runner Setup Environment

## Overview

This directory contains an Ansible-based automation solution for deploying and managing GitHub Actions self-hosted runners on remote machines. The playbook automates runner installation, configuration, and startup using a flexible JSON-based configuration system that supports multiple organizations, runner groups, and instances.

## Requirements

### System Requirements
- **Python 3** - Required for Ansible and virtual environment
- **Bash** - Shell interpreter
- **SSH Access** - To target EC2 instances
- **Terraform** - Must be run first to provision infrastructure and generate inventory

### Auto-Installed Dependencies
The `run` script automatically installs the following in a Python virtual environment:
- **Ansible** - Configuration management tool
- **Python dependencies** - Managed via `requirements.txt`

**Note:** You do NOT need to manually install Ansible. The `run` script handles all setup automatically.

## Directory Structure

```
ansible_enviroment/
├── README.md                           # This documentation
├── run                                 # Automated setup and execution script
├── playbook.yml                        # Main Ansible playbook
├── .venv/                              # Python virtual environment (auto-generated)
├── requirements.txt                    # Python dependencies (auto-generated)
├── dependencies/                       # Configuration files for runners
│   ├── README.md                       # Dependencies folder documentation
│   └── runners_config.json             # Runner configuration (JSON format)
└── scripts/                            # Shell scripts executed on remote hosts
    ├── 00-install-dependencies.sh      # System dependencies installation
    └── 11-setup_runners.sh             # Runner setup using JSON config
```

## Quick Start

1. **Run Terraform first** to provision infrastructure and generate `../config/config.ini`

2. **Configure GitHub Runner Token**
   - Edit `../config/config.ini`
   - Set the `github_runner_token` value (get from GitHub repo settings)

3. **Deploy Runners**
   ```bash
   cd ansible_enviroment
   ./run [CONFIG_PATH]
   ```

   **Examples:**
   - Default location: `./run` (uses `../config/config.ini`)
   - Custom location: `./run /path/to/my-config.ini`
   - Absolute path: `./run ~/configs/production.ini`

The `run` script will automatically:
- ✓ Validate configuration file and GitHub token
- ✓ Check Python 3 installation
- ✓ Create/reuse Python virtual environment
- ✓ Install Ansible
- ✓ Execute the playbook
- ✓ Report results with appropriate exit codes

**Exit Codes:** 0=Success, 1=Config missing, 2=Empty token, 3=No Python3, 4-6=Environment errors, 7+=Ansible errors

## Configuration

### Inventory File (`../config/config.ini`)
The inventory file is **automatically generated by Terraform** and contains Ansible connection settings.

**Required fields:**
```ini
[runners]
# Individual IPs (one per line)
1.2.3.4
5.6.7.8

[runners:vars]
ansible_ssh_private_key_file=~/.ssh/your_key.pem
ansible_user=ubuntu
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
ansible_python_interpreter=/usr/bin/python3

# GitHub Runner Token (required)
github_runner_token=YOUR_TOKEN_HERE
```

**Note:** Only `github_runner_token` is used from the config.ini. All other runner settings are configured in `dependencies/runners_config.json`.

### Runner Configuration (`dependencies/runners_config.json`)
The main runner configuration file in JSON format. This defines runner versions, organizations, groups, and instances.

**Structure:**
```json
{
  "runners_config": {
    "runner_version": "2.329.0",
    "runner_platform": "linux-x64",
    "runner_sha256": "194f1e1e4bd02f80b7e9633fc546084d8d4e19f3928a324d512ea53430102e1d",
    "vms": [
      {
        "base_path": "/home/ubuntu/actions-runner",
        "organizations": [
          {
            "name": "org-name",
            "github_url": "https://github.com/org-name",
            "token": "${GITHUB_TOKEN_ORG}",
            "runner_groups": [
              {
                "name": "Default",
                "github_name": "default",
                "instances": 1
              }
            ]
          }
        ]
      }
    ]
  }
}
```

**Key configuration options:**
- `runner_version`: GitHub runner version to install
- `runner_platform`: Platform architecture (e.g., linux-x64)
- `runner_sha256`: SHA256 hash for download validation
- `base_path`: Installation directory on remote host
- `organizations`: Array of GitHub organizations/repos
- `token`: Can reference environment variable (e.g., `${GITHUB_TOKEN_ORG}`)
- `runner_groups`: Define multiple runner groups with different labels
- `instances`: Number of runner instances per group

## Components

### Scripts

#### `00-install-dependencies.sh`

Installs system-level dependencies required for the GitHub runner.

**What it does:**
- Updates system packages
- Installs essential tools: `curl`, `tar`, `git`, `coreutils`, `jq`, `wget`, `unzip`
- Validates that critical commands are available

**Execution:** Runs as root via `become: yes`

#### `11-setup_runners.sh`

Main runner installation and configuration script that supports multiple organizations and runner groups.

**What it does:**
- Reads configuration from JSON file (`dependencies/runners_config.json`)
- Downloads GitHub Actions runner package once (version specified in JSON)
- Validates download integrity using SHA256 hash
- Supports multiple VMs, organizations, runner groups, and instances
- Creates organized directory structure: `base_path/org_name/group_name/runner-N/`
- Configures each runner with unique names
- Attempts to install as systemd service, falls back to background process
- Includes smart skip logic: won't reinstall if runner is already running

**Input:**
- Takes JSON config file path as first argument
- Environment variable `GITHUB_TOKEN_ORG` passed from playbook

**Execution:** Runs as ansible_user (NOT root)

**Configuration structure:**
- Supports multiple organizations per VM
- Each organization can have multiple runner groups
- Each group can have multiple runner instances
- Token can reference environment variables using `${VAR_NAME}` syntax

## How It Works

1. **Validation Phase**
   - `run` script validates config.ini exists and `github_runner_token` is not empty
   - Sets up Python virtual environment and installs Ansible

2. **Playbook Execution**
   - Creates `/tmp/dependencies/` directory on remote hosts
   - Copies all files from `dependencies/` folder (including `runners_config.json`)
   - Creates `/tmp/scripts/` directory on remote hosts
   - Copies all scripts from `scripts/` folder

3. **Dependency Installation (00-install-dependencies.sh)**
   - Executes as root user
   - Installs system packages: curl, tar, git, jq, wget, unzip
   - Validates critical commands are available

4. **Runner Setup (11-setup_runners.sh)**
   - Executes as ansible_user (NOT root)
   - Reads configuration from `/tmp/dependencies/runners_config.json`
   - Downloads runner package once with SHA256 validation
   - Iterates through VMs → Organizations → Runner Groups → Instances
   - Creates directory structure: `base_path/org_name/group_name/runner-N/`
   - Configures each runner with GitHub
   - Attempts systemd service installation, falls back to background process
   - Environment variable `GITHUB_TOKEN_ORG` passed from playbook

## Checking Runner Status

**On remote host:**
```bash
# Check systemd service status
cd /home/ubuntu/actions-runner/org-name/group-name/runner-1
sudo ./svc.sh status

# Check background process
ps aux | grep run.sh

# View runner logs
tail -f /home/ubuntu/actions-runner/org-name/group-name/runner-1/_diag/Runner_*.log
```

## Advanced Usage

### Custom Config Location

Use a custom config file location:
```bash
./run /path/to/custom-config.ini
```

### Running Against Specific Hosts

```bash
source .venv/bin/activate
ansible-playbook playbook.yml -i /path/to/config.ini --limit 3.64.165.193
```

### Updating Runner Version

1. Edit `dependencies/runners_config.json`
2. Update the following fields:
   - `runner_version`: New version number (e.g., "2.330.0")
   - `runner_sha256`: New SHA256 hash for the package
3. Get the new SHA256 from [GitHub Actions Runner Releases](https://github.com/actions/runner/releases)
4. Run: `./run`

### Configuring Multiple Organizations

Edit `dependencies/runners_config.json` to add multiple organizations:
```json
{
  "runners_config": {
    "vms": [{
      "base_path": "/home/ubuntu/actions-runner",
      "organizations": [
        {
          "name": "org1",
          "github_url": "https://github.com/org1",
          "token": "${GITHUB_TOKEN_ORG}",
          "runner_groups": [...]
        },
        {
          "name": "org2",
          "github_url": "https://github.com/org2",
          "token": "${GITHUB_TOKEN_ORG_2}",
          "runner_groups": [...]
        }
      ]
    }]
  }
}
```

## Error Handling

- The `run` script uses `set -e` to exit on first error during setup
- 11-setup_runners.sh continues on individual runner failures to setup remaining runners
- SHA256 hash validation prevents corrupted downloads
- Smart skip logic: runners already running won't be reinstalled
- Setup summary shows successful and failed runners at the end
- Failed runner names are reported for troubleshooting

## Security Considerations

- Runner tokens should be treated as secrets
- Never commit `config.ini` or `runners_config.json` with real tokens to git
- Use environment variable references in JSON config: `${GITHUB_TOKEN_ORG}`
- Set environment variables before running playbook or use Ansible Vault
- SHA256 hash validation ensures download integrity
- Scripts run with minimum required privileges (root only for system packages)
- Temporary files are cleaned up automatically
- SSH strict host key checking is disabled for automation (consider enabling in production)

## Maintenance

### Remove Local Environment

```bash
rm -rf .venv/ requirements.txt
```

### Manually Removing Runners

To remove runners from remote hosts, SSH to each host and:
```bash
# Stop the service
cd /home/ubuntu/actions-runner/org-name/group-name/runner-1
sudo ./svc.sh stop
sudo ./svc.sh uninstall

# Remove the runner from GitHub
./config.sh remove --token YOUR_REMOVAL_TOKEN

# Delete the directory
cd ~
rm -rf /home/ubuntu/actions-runner
```

## Customization

### Adding New Scripts

1. Create a new shell script in `scripts/` directory
2. Use numeric prefix to control execution order
   - `0X-` for root execution
   - `1X-9X-` for user execution
3. Make script executable: `chmod +x scripts/XX-name.sh`
4. Use environment variables passed by playbook

### Modifying the `run` Script

The `run` script accepts an optional config path argument:
```bash
./run [CONFIG_PATH]
```

If not provided, defaults to `../config/config.ini`. Common modifications:
- Add additional validation checks
- Install additional Python packages
- Add pre/post execution hooks

## Contributing

When adding new scripts:
1. Follow the naming convention
2. Include comprehensive error handling
3. Add logging statements
4. Document environment variables
5. Test in isolation before integration

## License

Part of the terraform-github-constructor project.
