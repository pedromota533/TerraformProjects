# Ansible GitHub Runner Setup Environment

## Overview

This directory contains an Ansible-based automation solution for deploying and managing GitHub Actions self-hosted runners on remote machines. The playbook automates runner installation, configuration, and startup using a flexible JSON-based configuration system that supports multiple organizations, runner groups, and instances.

**Supported Platforms:**
- AWS EC2 instances (Ubuntu)
- Azure Virtual Machines (Ubuntu)

## Requirements

### System Requirements
- **Python 3** - Required for Ansible and virtual environment
- **Bash** - Shell interpreter
- **SSH Access** - To target EC2 instances
- **Terraform** - Must be run first to provision infrastructure and generate inventory

### Auto-Installed Dependencies
The `run` script automatically installs the following in a Python virtual environment:
- **Ansible** - Configuration management tool
- **Python dependencies** - Managed via `requirements.txt`

**Note:** You do NOT need to manually install Ansible. The `run` script handles all setup automatically.


## Quick Start

For detailed information about the `run` script, including all error codes and troubleshooting, see [Run Script Documentation](docs/run-script.md).

### AWS EC2 Runners

1. **Run Terraform first** to provision infrastructure and generate `../config/config.ini`

2. **Configure GitHub Runner Token**
   - Edit `../config/config.ini`
   - Set the `github_runner_token` value (get from GitHub repo settings)

3. **Deploy Runners**
   ```bash
   cd ansible_enviroment
   ./run --aws [CONFIG_PATH]
   ```

   **Examples:**
   - Default config: `./run --aws`
   - Custom location: `./run --aws /path/to/my-config.ini`
   - Absolute path: `./run --aws ~/configs/production.ini`

### Azure VM Runners

1. **Setup Azure VMs** with Ubuntu

2. **Configure config.ini** with Azure VM details (see Configuration section)

3. **Deploy Runners**
   ```bash
   cd ansible_enviroment
   ./run --azure [CONFIG_PATH]
   ```

   **Examples:**
   - Default config: `./run --azure`
   - Custom location: `./run --azure /path/to/azure-config.ini`


## Configuration

### Inventory File (`../config/config.ini`)

The inventory file serves as an Ansible inventory file containing connection details for your runner hosts. For AWS, this is **automatically generated by Terraform**. For Azure, you must create it manually.

**File Structure (AWS + Azure):**
```ini
[runners]
# AWS EC2 instance public IPs (automatically populated by Terraform)
# One IP per line - these are your runner hosts
3.64.165.193
18.184.207.45

[runners:vars]
# SSH Connection Settings (generated by Terraform for AWS)
ansible_ssh_private_key_file=~/.ssh/terraform-github-runner.pem
ansible_user=ubuntu
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
ansible_python_interpreter=/usr/bin/python3
# GitHub Runner Token for AWS runners (YOU MUST SET THIS MANUALLY)
github_runner_token=YOUR_TOKEN_HERE

[runners-azure]
# Azure VM public IPs (manually configured)
# One IP per line
20.123.45.67
40.234.56.78

[runners-azure:vars]
# SSH Connection Settings for Azure VMs
ansible_ssh_private_key_file=~/.ssh/azure-runner-key.pem
ansible_user=ubuntu
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
ansible_python_interpreter=/usr/bin/python3
# GitHub Runner Token for Azure runners (YOU MUST SET THIS MANUALLY)
github_runner_token=YOUR_TOKEN_HERE
```

**Field Descriptions:**

| Field | AWS (Generated By) | Azure (Manual) | Description |
|-------|-------------------|----------------|-------------|
| `[runners]` IPs | Terraform | N/A | Public IP addresses of AWS EC2 instances |
| `[runners-azure]` IPs | N/A | Manual | Public IP addresses of Azure VMs |
| `ansible_ssh_private_key_file` | Terraform / Manual | Manual | Path to SSH private key (.pem or .key file) |
| `ansible_user` | Terraform | Manual | SSH user (typically `ubuntu` for Ubuntu) |
| `ansible_ssh_common_args` | Terraform | Manual | SSH options (can disable host key checking) |
| `ansible_python_interpreter` | Terraform | Manual | Python path on remote hosts |
| `github_runner_token` | **Manual** | **Manual** | GitHub runner registration token (required) |

**Important Notes:**
- For AWS: Terraform generates everything **except** `github_runner_token` in `[runners:vars]`
- For Azure: You must manually configure the entire `[runners-azure]` section including `github_runner_token`
- Each section has its **own** `github_runner_token` - they can be the same or different tokens
- Never commit this file with real tokens or SSH keys to version control
- The token is read from the respective `[vars]` section based on the provider you're deploying to

**Usage:**
```bash
# AWS runners (--aws flag is REQUIRED)
./run --aws                        # Uses default: ../config/config.ini
./run --aws /path/to/custom.ini    # Uses custom location

# Azure runners (--azure flag is REQUIRED)
./run --azure                      # Uses default: ../config/config.ini
./run --azure /path/to/azure.ini   # Uses custom location
```

### Runner Configuration (`dependencies/runners_config.json`)
The main runner configuration file in JSON format. This defines runner versions, organizations, groups, and instances.

**Structure:**
```json
{
  "runners_config": {
    "runner_version": "2.329.0",
    "runner_platform": "linux-x64",
    "runner_sha256": "194f1e1e4bd02f80b7e9633fc546084d8d4e19f3928a324d512ea53430102e1d",
    "vms": [
      {
        "base_path": "/home/ubuntu/actions-runner",
        "organizations": [
          {
            "name": "org-name",
            "github_url": "https://github.com/org-name",
            "token": "${GITHUB_TOKEN_ORG}",
            "runner_groups": [
              {
                "name": "Default",
                "github_name": "default",
                "instances": 1
              }
            ]
          }
        ]
      }
    ]
  }
}
```

**Key configuration options:**
- `runner_version`: GitHub runner version to install
- `runner_platform`: Platform architecture (e.g., linux-x64)
- `runner_sha256`: SHA256 hash for download validation
- `base_path`: Installation directory on remote host
- `organizations`: Array of GitHub organizations/repos
- `token`: Can reference environment variable (e.g., `${GITHUB_TOKEN_ORG}`)
- `runner_groups`: Define multiple runner groups with different labels
- `instances`: Number of runner instances per group

## Troubleshooting

### Running Against Specific Hosts

```bash
source .venv/bin/activate
ansible-playbook playbook.yml -i /path/to/config.ini --limit 3.64.165.193
```

### Removing Runners

To remove runners from remote hosts, SSH to each host and:
```bash
# Stop the service
cd /home/ubuntu/actions-runner/org-name/group-name/runner-1
sudo ./svc.sh stop
sudo ./svc.sh uninstall

# Remove the runner from GitHub
./config.sh remove --token YOUR_REMOVAL_TOKEN

# Delete the directory
cd ~
rm -rf /home/ubuntu/actions-runner
```
