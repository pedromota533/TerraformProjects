name: Test Self-Hosted Runner

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-runner.yml'

jobs:
  test-runner:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display runner information
        run: |
          echo "=========================================="
          echo "RUNNER INFORMATION"
          echo "=========================================="
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Architecture: $RUNNER_ARCH"
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "=========================================="

      - name: System information
        run: |
          echo "=========================================="
          echo "SYSTEM INFORMATION"
          echo "=========================================="
          echo "OS Release:"
          cat /etc/os-release | head -5
          echo ""
          echo "Kernel Version:"
          uname -a
          echo ""
          echo "CPU Info:"
          grep "model name" /proc/cpuinfo | head -1
          echo ""
          echo "Memory Info:"
          free -h
          echo ""
          echo "Disk Space:"
          df -h | grep -E '^/dev/'
          echo "=========================================="

      - name: Verify installed tools
        run: |
          echo "=========================================="
          echo "INSTALLED TOOLS VERIFICATION"
          echo "=========================================="

          echo "‚úì Terraform:"
          terraform version || echo "‚ùå Terraform not found"
          echo ""

          echo "‚úì Ansible:"
          ansible --version | head -1 || echo "‚ùå Ansible not found"
          echo ""

          echo "‚úì AWS CLI:"
          aws --version || echo "‚ùå AWS CLI not found"
          echo ""

          echo "‚úì Python3:"
          python3 --version || echo "‚ùå Python3 not found"
          echo ""

          echo "‚úì jq:"
          jq --version || echo "‚ùå jq not found"
          echo ""

          echo "‚úì Git:"
          git --version || echo "‚ùå Git not found"
          echo "=========================================="

      - name: Test network connectivity
        run: |
          echo "=========================================="
          echo "NETWORK CONNECTIVITY TEST"
          echo "=========================================="
          echo "Public IP:"
          curl -s ifconfig.me || echo "Unable to get public IP"
          echo ""
          echo ""
          echo "DNS Resolution Test:"
          nslookup github.com || echo "DNS resolution failed"
          echo "=========================================="

      - name: Runner health check
        run: |
          echo "=========================================="
          echo "RUNNER HEALTH CHECK"
          echo "=========================================="
          echo "‚úÖ Runner is operational and can execute jobs!"
          echo "‚úÖ All critical tools are installed"
          echo "‚úÖ Network connectivity is working"
          echo "=========================================="
          echo ""
          echo "üéâ Self-Hosted Runner Test: PASSED üéâ"
          echo ""
